import json
import io
import zipfile
import urllib.request
import xml.etree.ElementTree as ET


def _make_cwe_json(root):
    """Convert CWE XML to JSON file

    args:
        root (xml.etree.ElementTree): root of XML format CWE data

    returns:
        dict: map from CWE ID to data
    """
    cwe_dict = {}
    for child1 in root:
        if ('Weaknesses' in child1.tag):
            key = 'None'
            childof = []
            peer = []
            parent = []
            for child2 in child1:
                if ('ID' in child2.attrib):
                    key = 'CWE-' + child2.attrib['ID']
                    name = child2.attrib['Name']
                    for child3 in child2:
                        if ('Description' in child3.tag
                                and 'Extended' not in child3.tag):
                            description = child3.text
                        for child4 in child3:
                            if ('Nature' in child4.attrib):
                                if ('ChildOf' in child4.attrib['Nature']):
                                    parent.append(
                                        'CWE-' + child4.attrib['CWE_ID'])
                                if ('PeerOf' in child4.attrib['Nature']):
                                    peer.append(
                                        'CWE-' + child4.attrib['CWE_ID'])
                if ('None' not in key):
                    if (len(childof) < 1):
                        childof = 'None'
                    if (len(peer) < 1):
                        peer = 'None'
                    if (len(parent) < 1):
                        parent = 'None'
                    cwe_dict[key] = {
                        "Name": name,
                        "Description": description,
                        "Parent": parent,
                        "Child": childof,
                        "Peer": peer
                    }
                    key = 'None'
                    childof = []
                    peer = []
                    parent = []

    for i in cwe_dict:
        childof = []
        for j in cwe_dict:
            if ('None' not in cwe_dict[j]['Parent']
               and i != j and i in cwe_dict[j]['Parent']):
                childof.append(j)
        childof = list(set(childof))
        if (len(childof) > 0):
            cwe_dict[i]['Child'] = childof

    return cwe_dict


def download_cwe(path_cwe):
    """Download the CWE List and store it as a JSON file

    args:
        path_cwe (str): file path to the CWE JSON file
    """
    d_URL = "https://cwe.mitre.org/data/xml/cwec_latest.xml.zip"

    with urllib.request.urlopen(d_URL) as zip_file:
        with zipfile.ZipFile(io.BytesIO(zip_file.read())) as zfd:
            lst = zfd.namelist()
            tree = ET.fromstring(zfd.read(lst[0]))
            cwe2data = _make_cwe_json(tree)

            with open(path_cwe, 'w') as f:
                json.dump(cwe2data, f, indent=4)
