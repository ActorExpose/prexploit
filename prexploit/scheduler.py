import time
import logging
from datetime import date

import schedule

from .job import train_model_and_predict_all, update_modified_cves

log = logging.getLogger(__name__)


def schedule_update_all(path_nvd, path_cwe,
                        path_exp_cves, path_model,
                        path_out,
                        time_str="04:00"):
    """Fetch NVD/Symantec and retrining and predict for all CVEs

    Args:
        path_nvd (stc):
        path_cwe (str):
        path_exp_cves (str):
        path_model (str):
        path_out (str):
        time_str (str): Defaults `04:00`.
    """

    def _job():
        # Schedule doesn't provide monthly execution.
        # https://stackoverflow.com/questions/57221153/python-script-schedule-to-run-on-day-1-of-each-month-at-200-am
        if date.today().day != 1:
            return

        train_model_and_predict_all(
            path_nvd, path_cwe, path_exp_cves, path_model, path_out)
        log.info('end job for update all')

    schedule.every().day.at(time_str).do(_job)


def schedule_update_modified_cves(path_nvd, path_cwe,
                                  path_exp_cves, path_model,
                                  path_out):

    def _job():
        update_modified_cves(
            path_nvd, path_cwe, path_exp_cves, path_model, path_out)
        log.info('end job for update modified CVEs')

    schedule.every(2).hours.do(_job)


def run_forever():
    min_schedule_time = 1
    while True:
        schedule.run_pending()
        time.sleep(min_schedule_time)
